<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Location Permission Demo</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; margin: 24px; }
    button { padding: 12px 16px; font-size: 16px; cursor: pointer; }
    .box { margin-top: 16px; padding: 14px; border: 1px solid #ddd; border-radius: 8px; }
    .ok { background: #f4fff4; }
    .err { background: #fff5f5; }
    .muted { color: #555; }
    code { background: #f6f8fa; padding: 2px 4px; border-radius: 4px; }
    a { word-break: break-all; }
  </style>
</head>
<body>
  <h1>Location Permission</h1>
  <p class="muted">
    Notes for Safari: this must be served over <b>HTTPS</b> (or <code>localhost</code>).
    Location prompts will only appear after a user gesture (button click).
  </p>

  <button id="btn">Request Location</button>

  <div id="status" class="box muted">Click “Request Location” to begin.</div>
  <div id="result" class="box" style="display:none;"></div>

  <script>
    const btn = document.getElementById('btn');
    const statusEl = document.getElementById('status');
    const resultEl = document.getElementById('result');

    function setStatus(message, type) {
      statusEl.className = 'box ' + (type || 'muted');
      statusEl.textContent = message;
    }

    function showResult(html, type) {
      resultEl.style.display = 'block';
      resultEl.className = 'box ' + (type || '');
      resultEl.innerHTML = html;
    }

    function isSecureContextForGeo() {
      // Safari and most browsers require HTTPS or localhost for geolocation.
      const isLocalhost =
        location.hostname === 'localhost' ||
        location.hostname === '127.0.0.1' ||
        location.hostname === '[::1]';
      return window.isSecureContext || isLocalhost;
    }

    function requestLocation() {
      resultEl.style.display = 'none';

      if (!('geolocation' in navigator)) {
        setStatus('Geolocation is not supported in this browser.', 'err');
        return;
      }

      if (!isSecureContextForGeo()) {
        setStatus('Geolocation requires HTTPS (or localhost). Serve this page over HTTPS and try again.', 'err');
        return;
      }

      setStatus('Requesting location permission...', 'muted');

      const options = {
        enableHighAccuracy: true,
        timeout: 15000,
        maximumAge: 0
      };

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude, accuracy } = pos.coords;
          const ts = new Date(pos.timestamp);

          setStatus('Location permission granted.', 'ok');

          const mapsUrl = `https://www.google.com/maps?q=${encodeURIComponent(latitude + ',' + longitude)}`;

          showResult(`
            <div><b>Current Location</b></div>
            <div>Latitude: <b>${latitude}</b></div>
            <div>Longitude: <b>${longitude}</b></div>
            <div>Accuracy: <b>${accuracy}</b> meters</div>
            <div>Timestamp: <b>${ts.toString()}</b></div>
            <div style="margin-top:10px;">
              Map: <a href="${mapsUrl}" target="_blank" rel="noopener noreferrer">${mapsUrl}</a>
            </div>
          `, 'ok');
        },
        (err) => {
          // Safari uses the same error codes but UX differs.
          let msg = 'Unable to retrieve location.';
          if (err && typeof err.code === 'number') {
            switch (err.code) {
              case err.PERMISSION_DENIED:
                msg = 'Permission denied. Please allow location access in your browser or site settings and try again.';
                break;
              case err.POSITION_UNAVAILABLE:
                msg = 'Location information is unavailable. Check GPS/Wi-Fi and try again.';
                break;
              case err.TIMEOUT:
                msg = 'Location request timed out. Try again in an open area or with better connectivity.';
                break;
              default:
                msg = 'An unknown error occurred while retrieving location.';
            }
          }
          setStatus(msg, 'err');
          showResult(`<b>Error</b><div>${msg}</div><div class="muted">Code: ${err && err.code ? err.code : 'N/A'} | ${err && err.message ? err.message : ''}</div>`, 'err');
        },
        options
      );
    }

    // User gesture is important for Safari.
    btn.addEventListener('click', requestLocation);
  </script>
</body>
</html>
